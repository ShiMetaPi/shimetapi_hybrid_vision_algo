# Hybrid Vision Algo(HVAlgo) - é«˜æ€§èƒ½äº‹ä»¶è§†è§‰ç®—æ³•åº“

**ä¸­æ–‡** | [English](README_EN.md)

## ç®€ä»‹

HVAlgo æ˜¯ShiMetaPi ä¸“ä¸ºäº‹ä»¶ç›¸æœºï¼ˆEvent Cameraï¼‰è®¾è®¡çš„é«˜æ€§èƒ½ç®—æ³•åº“ï¼Œæä¾›äº†å¤šç§å…ˆè¿›çš„äº‹ä»¶å»å™ªã€è®¡ç®—æœºè§†è§‰å’Œå›¾åƒæ¢å¤ç®—æ³•ã€‚è¯¥åº“åŸºäºShiMetaPi Hybird Vision SDK æ„å»ºï¼Œæ”¯æŒå®æ—¶äº‹ä»¶æµå¤„ç†ï¼Œé€‚ç”¨äºæœºå™¨äººè§†è§‰ã€è‡ªåŠ¨é©¾é©¶ã€é«˜é€Ÿè¿åŠ¨åˆ†æç­‰åº”ç”¨åœºæ™¯ã€‚

ShiMetaPi Hybrid Vision SDK ç”± hybrid_vision_toolkit å’Œ hybrid_vision_algo ä¸¤ä¸ªç‹¬ç«‹çš„SDKç»„æˆï¼Œåˆ†åˆ«å®ç°è§†è§‰èåˆç›¸æœºçš„æ¥å£æ§åˆ¶å’Œç®—æ³•å¤„ç†ã€‚

## é¡¹ç›®æ¡†å›¾

![æ¡†å›¾](./assets/imgs/block_diagram.png)

## **`shimetapi_Hybrid_vision_algo (ç®—æ³•å±‚ SDK)`**

- **å®šä½ï¼š** è¿™æ˜¯ SDK çš„æ ¸å¿ƒç®—æ³•å¤„ç†å±‚ï¼Œä½äºæ¶æ„çš„ä¸­é—´å±‚ï¼ˆé»„è‰²éƒ¨åˆ†ï¼‰ã€‚
- **æ ¸å¿ƒåŠŸèƒ½ï¼š** ä¸“æ³¨äºå¤„ç†æ¥è‡ªäº‹ä»¶ç›¸æœºçš„åŸå§‹æ•°æ®æµï¼Œæ‰§è¡Œé«˜çº§çš„è®¡ç®—æœºè§†è§‰ç®—æ³•ï¼Œä»¥æå‡æ•°æ®è´¨é‡ã€æå–æœ‰ç”¨ä¿¡æ¯æˆ–è¿›è¡Œä¸‰ç»´ç†è§£ã€‚
- **åŒ…å«çš„æ¨¡å—ï¼š**
  - **é™å™ª (`Denoise`):** å»é™¤äº‹ä»¶æµä¸­çš„å™ªå£°ï¼Œæé«˜ä¿¡å·è´¨é‡ã€‚
  - **æ’å€¼ (`Interpolation`):** ç”¨äºåœ¨äº‹ä»¶ä¹‹é—´ç”Ÿæˆä¸­é—´æ•°æ®ç‚¹ï¼Œæˆ–ä¸æ ‡å‡†å¸§å›¾åƒè¿›è¡Œæ—¶ç©ºå¯¹é½/èåˆã€‚
  - **ä¿®å¤ (`Restoration`):** ç”¨äºå¤„ç†æ•°æ®ç¼ºå¤±æˆ–å¼‚å¸¸ã€‚
  - **è®¡ç®—æœºè§†è§‰/ä¸‰ç»´è§†è§‰ (`CV/CV3D`):** åŒ…å«å®ç°äº‹ä»¶ç›¸æœºç‰¹å®šæˆ–èåˆåº”ç”¨çš„ç®—æ³•ï¼Œå¦‚ç›®æ ‡æ£€æµ‹ã€è·Ÿè¸ªã€ä¸‰ç»´é‡å»ºã€å§¿æ€ä¼°è®¡ç­‰ã€‚
  - **æ ·æœ¬ä¸æ•°æ® (`Samples/data`):** æä¾›ç¤ºä¾‹ä»£ç ã€æ¨¡å‹æˆ–å¿…è¦çš„æ•°æ®é›†ã€‚
  - **å¤–éƒ¨ä¾èµ– (`external`):** é€šè¿‡é›†æˆç¬¬ä¸‰æ–¹åº“ç»™ç”¨æˆ·æä¾›æ›´å¤šè®¾å¤‡çš„é€‰æ‹©,ä¾‹å¦‚ï¼šshimetapi Hybrid vision toolkit`ï¼ŒOpenEb(é€šè¿‡å‘½ä»¤å®‰è£…)ç­‰ ã€‚
- **ä½œç”¨ï¼š** å®ƒä¸ºä¸Šå±‚åº”ç”¨ (`APP`) æä¾›äº†ç»è¿‡å¤„ç†ã€å¢å¼ºæˆ–ç†è§£çš„äº‹ä»¶æ•°æ®ä¿¡æ¯ã€‚åº”ç”¨å¼€å‘è€…ä¸»è¦è°ƒç”¨è¿™ä¸€å±‚çš„æ¥å£æ¥å®ç°äº‹ä»¶ç›¸æœºçš„é«˜çº§åŠŸèƒ½ï¼ˆå¦‚æ’­æ”¾ã€å½•åˆ¶ã€åˆ†æï¼‰ã€‚

## **`shimetapi_Hybrid_vision_toolkit (HALå±‚å·¥å…·åŒ…)`**

- **å®šä½ï¼š** è¿™æ˜¯ SDK çš„ ç¡¬ä»¶æŠ½è±¡å±‚ (HAL) å’ŒåŸºç¡€å·¥å…·å±‚ ï¼Œä½äºç®—æ³•å±‚ä¹‹ä¸‹ï¼ˆæ·±è“è‰²éƒ¨åˆ†ï¼‰ã€‚
- **æ ¸å¿ƒåŠŸèƒ½ï¼š** æä¾›ä¸ç¡¬ä»¶äº¤äº’å’Œæ•°æ®æµåŸºç¡€æ“ä½œçš„åŠŸèƒ½ã€‚å®ƒè´Ÿè´£ä»ç‰©ç†æ¥å£è¯»å–åŸå§‹æ•°æ®ï¼Œè¿›è¡Œåˆæ­¥å¤„ç†ï¼ˆå¦‚ç¼–è§£ç ï¼‰ï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™ä¸Šå±‚ç®—æ³•å±‚ï¼ŒåŒæ—¶ä¹Ÿæ¥æ”¶ä¸Šå±‚æŒ‡ä»¤æ§åˆ¶ç¡¬ä»¶ã€‚
- **åŒ…å«çš„å…³é”®æ¨¡å—/åŠŸèƒ½ï¼š**
  - **è¯»å– (`Read`):** ä»ç¡¬ä»¶æ¥å£ï¼ˆå¦‚ USBï¼‰è·å–åŸå§‹äº‹ä»¶æ•°æ®æµã€‚
  - **å†™å…¥ (`Write`):** ç”¨äºå°†å¤„ç†åçš„æ•°æ®æˆ–æ§åˆ¶æŒ‡ä»¤å‘é€å›ç¡¬ä»¶ï¼ˆå¦‚æœæ”¯æŒï¼‰ã€‚
  - **è®¾ç½® (`Setting`):** é…ç½®ç›¸æœºå‚æ•°ï¼ˆå¦‚åˆ†è¾¨ç‡ã€çµæ•åº¦ç­‰ï¼‰ã€‚
  - **è§£ç å™¨ (`Decoder`):** å¦‚æœäº‹ä»¶æ•°æ®ä»¥ç‰¹å®šæ ¼å¼ç¼–ç ä¼ è¾“ï¼Œè´Ÿè´£å°†å…¶è§£ç ä¸ºå¯å¤„ç†çš„æ ¼å¼ã€‚
  - **ç¼–ç å™¨ (`Encoder`):** ç”¨äºå°†å¤„ç†åçš„æ•°æ®æˆ–å½•åˆ¶çš„æµç¼–ç ä¸ºç‰¹å®šæ ¼å¼ã€‚
- **ä½œç”¨ï¼š** å®ƒæŠ½è±¡äº†åº•å±‚ç¡¬ä»¶çš„ç»†èŠ‚ï¼Œä¸ºä¸Šå±‚ç®—æ³•å±‚ (`shimetapi_Hybrid_vision_algo`) æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ã€ç›¸å¯¹ç¡¬ä»¶æ— å…³çš„æ¥å£æ¥è®¿é—®å’Œæ§åˆ¶äº‹ä»¶ç›¸æœºæ•°æ®æµã€‚å®ƒå¤„ç†åº•å±‚çš„é€šä¿¡åè®®ã€æ•°æ®æ¬è¿å’ŒåŸºç¡€æ ¼å¼è½¬æ¢ã€‚

## **æ€»ç»“ä¸¤è€…çš„å…³ç³»ä¸åä½œï¼š**

1. **`shimetapi_Hybrid_vision_toolkit (å·¥å…·åŒ…/HALå±‚):`**
   - ç›´æ¥ä¸ç¡¬ä»¶å’Œåº•å±‚ç³»ç»ŸSDK æ‰“äº¤é“ã€‚
   - è´Ÿè´£è·å–åŸå§‹æ•°æ® (`Read`)ï¼Œè¿›è¡ŒåŸºç¡€æ ¼å¼è½¬æ¢ (`Decoder`)ï¼Œæ§åˆ¶ç¡¬ä»¶(`Setting`)ï¼Œå¹¶è¾“å‡ºæ•°æ®(`Write`, `Encoder`)ç­‰ã€‚
   - å‘ä¸Šå±‚ (`algo` å±‚) æä¾› æ ‡å‡†åŒ–çš„æ•°æ®è®¿é—®æ¥å£ ã€‚
2. **`shimetapi_Hybrid_vision_algo (ç®—æ³•å±‚):`**
   - æ„å»ºåœ¨ `toolkit` å±‚ä¹‹ä¸Šã€‚
   - æ¥æ”¶æ¥è‡ª `toolkit` å±‚çš„ æ ‡å‡†åŒ–äº‹ä»¶æ•°æ®æµ ã€‚
   - åˆ©ç”¨å…¶åŒ…å«çš„é«˜çº§ç®—æ³•æ¨¡å— (`Denoise`, `Interpolation`, `CV/CV3D` ç­‰) å¯¹æ•°æ®è¿›è¡Œ å¤„ç†ã€å¢å¼ºã€åˆ†æå’Œç†è§£ ã€‚
   - å°†å¤„ç†åçš„ã€æ›´æœ‰ä»·å€¼çš„ä¿¡æ¯æä¾›ç»™æœ€ä¸Šå±‚çš„åº”ç”¨ç¨‹åº (`APP`)ä½¿ç”¨ï¼ˆå¦‚æ˜¾ç¤º `UI`ã€`Player` æ’­æ”¾ã€`Recorder` å½•åˆ¶ã€`Analyzer` åˆ†æï¼‰ã€‚
   - å…¼å®¹ä¸åŒå‚å•†æ¥å£ï¼ˆç›®å‰æ”¯æŒShiMetaPi HV Toolkitå’ŒOpenebï¼‰ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„ C++17 å®ç°ï¼Œæ”¯æŒå®æ—¶äº‹ä»¶æµå¤„ç†
- ğŸ§  **å¤šç§å»å™ªç®—æ³•**: åŒ…å«ä¼ ç»Ÿå’Œæ·±åº¦å­¦ä¹ æ–¹æ³•
- ğŸ”§ **æ˜“äºé›†æˆ**: æä¾› CMake é…ç½®å’Œ pkg-config æ”¯æŒ
- ğŸ“¦ **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
- ğŸ¯ **å®ç”¨ç¤ºä¾‹**: ä¸°å¯Œçš„ç¤ºä¾‹ä»£ç å’Œæ–‡æ¡£

## ç®—æ³•æ¨¡å—

### å»å™ªç®—æ³• (Denoise)

1. **åŒçª—å£æ»¤æ³¢å™¨ (Double Window Filter)**

   - ä½¿ç”¨ä¸¤ä¸ªå¾ªç¯ç¼“å†²åŒºå¯¹äº‹ä»¶è¿›è¡Œåˆ†ç±»
   - é€‚ç”¨äºä½å™ªå£°ç¯å¢ƒçš„å®æ—¶å¤„ç†
2. **äº‹ä»¶æµæ»¤æ³¢å™¨ (Event Flow Filter)**

   - åŸºäºäº‹ä»¶æµå¯†åº¦å’Œæµé€Ÿç‰¹å¾çš„å™ªå£°æŠ‘åˆ¶
   - é€‚ç”¨äºè¿åŠ¨åœºæ™¯çš„å»å™ª
3. **Khodamoradi å»å™ªå™¨**

   - åŸºäºæ—¶ç©ºé‚»åŸŸçš„ç»å…¸å»å™ªç®—æ³•
   - å¹³è¡¡æ€§èƒ½å’Œæ•ˆæœçš„é€šç”¨è§£å†³æ–¹æ¡ˆ
4. **é€’å½’äº‹ä»¶å»å™ªå™¨ (Reclusive Event Denoiser)**

   - é€’å½’å¼äº‹ä»¶å¤„ç†ç®—æ³•
   - é€‚ç”¨äºå¤æ‚å™ªå£°ç¯å¢ƒ
5. **æ—¶é—´è¡¨é¢å»å™ªå™¨ (Time Surface Denoiser)**

   - åŸºäºæ—¶é—´è¡¨é¢çš„å»å™ªæ–¹æ³•
   - ä¿æŒäº‹ä»¶æ—¶åºç‰¹æ€§
6. **Yang å™ªå£°æ»¤æ³¢å™¨**

   - Yang ç­‰äººæå‡ºçš„å™ªå£°æ»¤æ³¢ç®—æ³•
   - é«˜æ•ˆçš„å®æ—¶å¤„ç†èƒ½åŠ›
7. **å¤šå±‚æ„ŸçŸ¥æœºæ»¤æ³¢å™¨ (MLP Filter)** *(å¯é€‰)*

   - åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½å»å™ª
   - éœ€è¦ PyTorch æ”¯æŒ
   - é€‚ç”¨äºå¤æ‚åœºæ™¯çš„é«˜ç²¾åº¦å»å™ª

### è®¡ç®—æœºè§†è§‰ (CV)

- åŸºç¡€å›¾åƒå¤„ç†ç®—æ³•
- ç‰¹å¾æå–å’ŒåŒ¹é…

### ä¸‰ç»´è§†è§‰ (CV3D)

- ç«‹ä½“è§†è§‰ç®—æ³•
- æ·±åº¦ä¼°è®¡
- ä¸‰ç»´é‡å»º

### å›¾åƒæ¢å¤ (Restoration)

- å›¾åƒå¢å¼ºç®—æ³•
- å»æ¨¡ç³Šå’Œè¶…åˆ†è¾¨ç‡

## ç³»ç»Ÿè¦æ±‚

### å¿…éœ€ä¾èµ–

- **Ubuntu** == 22.04
- **CMake** >= 3.16
- **C++17** å…¼å®¹ç¼–è¯‘å™¨
- **Eigen3**

### å¯é€‰ä¾èµ–

- **Openeb SDK**
- **PyTorch** (ç”¨äº MLP æ»¤æ³¢å™¨)
- **CUDA** (GPU åŠ é€Ÿæ”¯æŒ)

## å®‰è£…æŒ‡å—

### å®‰è£…ä¾èµ–

#### Ubuntu/Debian

```
# å®‰è£…åŸºç¡€ä¾èµ–
sudo apt update
sudo apt install cmake build-essential libeigen3-dev

# å®‰è£… Openeb
curl -L https://propheseeai.jfrog.io/artifactory/api/security/keypair/prophesee-gpg/public >/tmp/propheseeai.jfrog.op.asc
sudo cp /tmp/propheseeai.jfrog.op.asc /etc/apt/trusted.gpg.d
sudo add-apt-repository 'https://propheseeai.jfrog.io/artifactory/openeb-debian/'
sudo apt update
sudo apt -y install metavision-openeb
```

#### å¯é€‰: PyTorch æ”¯æŒ

```bash
# ä¸‹è½½ LibTorch
wget https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.7.1%2Bcpu.zip
unzip libtorch-cxx11-abi-shared-with-deps-2.7.1+cpu.zip
export CMAKE_PREFIX_PATH=/path/to/libtorch:$CMAKE_PREFIX_PATH
```

### å®‰è£…Shimeta Hybrid Vision Toolkit

æœ¬é¡¹ç›®åŒ…å« HV Toolkit å­ä»“åº“ï¼Œç”¨äºç®€åŒ–äº‹ä»¶æ•°æ®å¤„ç†ã€‚è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š

```bash
# æ‹‰å–å­ä»“åº“
git submodule update --init

# è¿›å…¥å­ä»“åº“ç›®å½•
cd external/shimetapi_hybrid_vision_toolkit/

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build && cd build

# é…ç½®CMake
cmake ..

# ç¼–è¯‘é¡¹ç›®
make -j$(nproc)

# å®‰è£…åº“æ–‡ä»¶
sudo make install
```

### ç¼–è¯‘å®‰è£…

```bash
mkdir build && cd build

# åŸºç¡€ç¼–è¯‘
cmake ..
make -j$(nproc)

# å¯ç”¨ PyTorch æ”¯æŒï¼ˆå¯é€‰ï¼‰
cmake -DENABLE_TORCH=ON ..
make -j$(nproc)

# å®‰è£…åˆ°ç³»ç»Ÿ
sudo make install
```

### ç¼–è¯‘é€‰é¡¹

| é€‰é¡¹                 | é»˜è®¤å€¼  | è¯´æ˜                     |
| -------------------- | ------- | ------------------------ |
| `ENABLE_TORCH`     | OFF     | å¯ç”¨ PyTorch æ”¯æŒ        |
| `BUILD_SAMPLES`    | OFF     | ç¼–è¯‘ç¤ºä¾‹ç¨‹åº             |
| `BUILD_TESTING`    | OFF     | ç¼–è¯‘æµ‹è¯•ç¨‹åº             |
| `CMAKE_BUILD_TYPE` | Release | ç¼–è¯‘ç±»å‹ (Debug/Release) |

## ä½¿ç”¨æ–¹æ³•

### CMake é›†æˆ

```cmake
find_package(HVAlgo REQUIRED)

add_executable(my_app main.cpp)
target_link_libraries(my_app HVAlgo::hv_algo)
```

### pkg-config é›†æˆ

```bash
# ç¼–è¯‘
g++ -o my_app main.cpp `pkg-config --cflags --libs hv_algo`
```

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```cpp
#include <denoise/double_window_filter.h>
#include <metavision/sdk/base/events/event_cd.h>

int main() {
    // åˆ›å»ºåŒçª—å£æ»¤æ³¢å™¨
    Shimeta::Algorithm::Denoise::DoubleWindowFilter filter(36, 9, 1);
  
    // å¤„ç†äº‹ä»¶
    Metavision::EventCD event;
    bool is_signal = filter.evaluate(event);
  
    if (is_signal) {
        // å¤„ç†æœ‰æ•ˆäº‹ä»¶
    }
  
    return 0;
}
```

## ç¤ºä¾‹ç¨‹åº

é¡¹ç›®æä¾›äº†ä¸°å¯Œçš„ç¤ºä¾‹ç¨‹åºï¼Œå±•ç¤ºå„ç§ç®—æ³•çš„ä½¿ç”¨æ–¹æ³•ï¼š

```bash
# ç¼–è¯‘ç¤ºä¾‹
cd samples/with_hv_toolkit
mkdir build && cd build
cmake ..
make
# è¿è¡Œç¤ºä¾‹
./dwf_denoising ../../../data/events.raw
```

ç¨‹åºè¿è¡Œæˆªå›¾
![æ›¿ä»£æ–‡æœ¬](./assets/imgs/run01.jpg)

### å¯ç”¨ç¤ºä¾‹

- `dwf_denoising`: åŒçª—å£æ»¤æ³¢å™¨å»å™ªç¤ºä¾‹
- `event_flow_denoising`: äº‹ä»¶æµæ»¤æ³¢å™¨ç¤ºä¾‹
- `khodamoradi_denoising`: Khodamoradi å»å™ªå™¨ç¤ºä¾‹
- `mlpf_denoising`: MLP æ»¤æ³¢å™¨ç¤ºä¾‹ (éœ€è¦ PyTorch)
- `re_denoising`: é€’å½’äº‹ä»¶å»å™ªå™¨ç¤ºä¾‹
- `ts_denoising`: æ—¶é—´è¡¨é¢å»å™ªå™¨ç¤ºä¾‹
- `y_denoising`: Yang æ»¤æ³¢å™¨ç¤ºä¾‹

## é¡¹ç›®ç»“æ„

```
hv_algo/
â”œâ”€â”€ include/                 # å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ denoise/            # å»å™ªç®—æ³•
â”‚   â”œâ”€â”€ cv/                 # è®¡ç®—æœºè§†è§‰
â”‚   â”œâ”€â”€ cv3d/               # ä¸‰ç»´è§†è§‰
â”‚   â””â”€â”€ restoration/        # å›¾åƒæ¢å¤
â”œâ”€â”€ src/                    # æºä»£ç 
â”œâ”€â”€ samples/                # ç¤ºä¾‹ç¨‹åº
â”‚   â”œâ”€â”€ with_metavision/    # Openeb SDK ç¤ºä¾‹
â”‚   â””â”€â”€ with_hv_toolkit/    # HV Toolkit ç¤ºä¾‹
â”œâ”€â”€ cmake/                  # CMake é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                   # æµ‹è¯•æ•°æ®
â”œâ”€â”€ models/                 # é¢„è®­ç»ƒæ¨¡å‹
â””â”€â”€ external/               # å¤–éƒ¨ä¾èµ–
```

## è‡´è°¢

- [Openeb SDK](https://docs.prophesee.ai/) - äº‹ä»¶ç›¸æœºå¼€å‘æ¡†æ¶
- [Eigen](https://eigen.tuxfamily.org/) - çº¿æ€§ä»£æ•°åº“
- [PyTorch](https://pytorch.org/) - æ·±åº¦å­¦ä¹ æ¡†æ¶

## è”ç³»æ–¹å¼

å¼€æºç¡¬ä»¶ç½‘ç«™ï¼š https://www.shimetapi.cn  (å›½å†…)   https://www.shimetapi.com   (æµ·å¤–)
åœ¨çº¿æŠ€æœ¯æ–‡æ¡£ï¼šhttps://forum.shimetapi.cn/wiki/zh/
åœ¨çº¿æŠ€æœ¯ç¤¾åŒºï¼šhttps://forum.shimetapi.cn

**æ³¨æ„**: æœ¬é¡¹ç›®ä»åœ¨ç§¯æå¼€å‘ä¸­ï¼ŒAPI å¯èƒ½ä¼šæœ‰å˜åŒ–ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚
